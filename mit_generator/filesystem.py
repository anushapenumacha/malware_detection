#!/usr/bin/env python

from utils import *
from process import Process

def handle_file(processes, line):
    time, fields = parse_line(line)
    operation = fields[0]
    pid = None
    filepath = None
    disposition = None

    if (operation =="IRP_MJ_CREATE" or
        operation == "IRP_MJ_SET_INFORMATION"):
        pid = extract_field(fields[1])
        filepath = extract_field(fields[2])
        disposition = extract_field(fields[3])

    elif (operation == "IRP_MJ_READ" or
          operation == "IRP_MJ_WRITE"):
        pid = extract_field(fields[1])
        filepath = extract_field(fields[3])

    else:
        pass

    if pid is not None:
        #If previously unseen, add to list of monitored processes
        if pid not in processes:
            processes[pid] = Process(pid, None)
            processes[pid].set_firstseen(time)

        #Add to the list of files created by this process
        if (operation == "IRP_MJ_CREATE" and
            disposition == "FILE_CREATE"):
            processes[pid].add_createfile(filepath)

        #Add to the list of files read by this process
        if operation == "IRP_MJ_READ":
            processes[pid].add_readfile(filepath)

        #Add to the list of files written to by this process
        if operation == "IRP_MJ_WRITE":
            processes[pid].add_writtenfile(filepath)

        #Add to the list of files modified by this process
        if (operation == "IRP_MJ_SET_INFORMATION" and
            disposition == "deletepending"):
            processes[pid].add_writtenfile(filepath)
