#!/usr/bin/env python

import glob
import ntpath
import sys
from loguru import logger
from ermd_analysis.analyzer import Analyzer
from ermd_analysis.config import Config
import sys


def main():
    logger.add("output/analysis_{time}.log")
    # Check for command line argument
    if len(sys.argv) != 2:
        logger.error("Failed to specify a configuration YAML file.")
        sys.exit(-1)

    # Load configuration YAML file
    try:
        config = Config(sys.argv[1])
    except:
        logger.error("Failed to set configurations. "
            "Check your YAML file structure.")
        sys.exit(1)

    # Perform analysis for each log file in path
    logfiles = glob.glob (
        config.log_path() + '/**/' + config.logfile_ptrn(), 
        recursive=True
    )
    count = config.count()
    for logfile in logfiles:
        if count == 0:
            break
        logger.debug(f"Analyzing {ntpath.basename(logfile)}...")
        analyzer = Analyzer()
        outputfile = config.output_dir() + ntpath.basename(logfile) + '.json'

        try:
            analyzer.parse_signature(logfile.replace('.log','.sig'))
        except UnicodeDecodeError as e:
            logger.error(f"Failed to parse {logfile.replace('.log', '.sig').split('/')[-1]} due to encoding issues.")
            logger.error(f"Skipping analysis of signature file...")
            logger.error(e)

        except FileNotFoundError as e:
            logger.error(f"Failed to open {logfile.replace('.log', '.sig').split('/')[-1]}")
            logger.error(f"Skipping analysis of signature file...")

        try:
            analyzer.analyze(config, logfile, outputfile)
        except Exception as e:
            logger.error(f"Failed to properly parse {logfile.split('/')[-1]}")
            print(e)

        count = count - 1
        print('\n')

if __name__ == '__main__':
    main()
