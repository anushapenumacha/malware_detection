#!/usr/bin/env python

import glob
import sys
from loguru import logger
from ermd_analysis.analyzer import Analyzer
from ermd_analysis.config import Config
import sys


def main():
    logger.add("output/analysis_{time}.log")
    # Check for command line argument
    if len(sys.argv) != 2:
        logger.error("Failed to specify a configuration YAML file.")
        sys.exit(-1)

    # Load configuration YAML file
    try:
        config = Config(sys.argv[1])
    except:
        logger.error("Failed to set configurations. "
            "Check your YAML file structure.")
        sys.exit(1)

    # Perform analysis for each log file in path
    logfiles = glob.glob (
        config.log_path() + '/**/' + config.logfile_ptrn(), 
        recursive=True
    )
    count = config.count()
    for logfile in logfiles:
        if count == 0:
            break
        logger.debug(f"Analyzing {logfile.split('/')[-1]}...")
        analyzer = Analyzer()
        try:
            outputfile = config.output_dir() + logfile.split('/')[-1] + '.json'
            analyzer.analyze(config, logfile, outputfile)
        except Exception as e:
            logger.error(f"Failed to properly parse {logfile.split('/')[-1]}")
            print(e)
        count = count - 1
        print('\n')

if __name__ == '__main__':
    main()
