#!/usr/bin/env python

import glob
import sys
from loguru import logger
from ermd_analysis.analyzer import Analyzer
from ermd_analysis.config import Config


def main():
    logger.add("output/analysis_{time}.log")
    # Check for command line argument
    if len(sys.argv) != 2:
        logger.error("Failed to specify a configuration YAML file.")
        sys.exit(-1)

    # Load configuration YAML file
    try:
        config = Config(sys.argv[1])
    except:
        logger.error("Failed to set configurations. "
            "Check your YAML file structure.")
        sys.exit(1)

    # Perform analysis for each log file in path
    logfiles = glob.glob (
        config.log_path() + '/**/' + config.logfile_ptrn(), 
        recursive=True
    )
    count = config.count()
    for logfile in logfiles:
        if count == 0:
            break
        logger.debug(f"Analyzing {logfile.split('/')[-1]}...")
        analyzer = Analyzer()
        analyzer.analyze(config, logfile, config.output_dir())
        count = count - 1

if __name__ == '__main__':
    main()
