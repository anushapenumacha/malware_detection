#!/usr/bin/env python

from ermd_analysis.event import *
from ermd_analysis.utils import *
from ermd_analysis.process import Process
from ermd_analysis.handler import EventHandler
from loguru import logger

class ProcHandler(EventHandler):
    def __init__(self):
        pass

    def handle(self, fields, tree):
        action = fields[0]

        if action == 'image-loaded':
            self.handle_loadimage(fields, tree)

        if action == 'True-ProcessCreated':
            self.handle_createprocess(fields, tree)
            
        if action == 'Process-Terminated':
            self.handle_terminateproc(fields, tree)

        if (action in 
            (
                'Proces-memory-write-accessattempt',
                'Proces-action-memory-write-accessattempt',
                'Proces-suspend-resume-acessattempt',
                'Proces-terminate-attempt',
                'Proce-smeomry-write-delete-access-attempt'
            )
        ):
            self.handle_openprocess(fields, tree)

        else:
            return

    def handle_loadimage(self, fields, tree):
        image_name = strip_hdr(fields[1])
        target = int(fields[2].split()[-1])
        injector = int(fields[3].split()[-1])
        addr = fields[4]

        if target == injector:
            return

        if target in tree.processes[injector].children:
            # Detecting Process Hollowing using Windows native executables
            if ((tree.processes[target].source_image.startswith('\\Windows')) and
                (image_name in tree.file_created)
            ):
                logger.debug("Process {injector} attempting to inject into Windows executable"
                    " {tree.processes[target].source_image} with PID {target}")
                tree.suspicion += 100.0
        
        # Process Injection into processes not in current tree
        if ((target not in tree.get_processes()) and 
            (any(system32.lower() not in image_name.lower() for system32 in SYSTEM32))
        ):
            logger.debug("Process {injector} attempting to inject into target process {target}")
            tree.suspicion += 100.0

    def handle_createprocess(self, fields, tree):
        pid = int(fields[1])
        ppid = int(fields[2])
        source_image = strip_hdr(fields[3])
        
        if ppid in tree.get_processes():
            logger.debug(f"Detected process {pid} created by {ppid}!")
            if source_image == tree.processes[ppid].source_image:
                logger.debug(f"Detected in-memory propagation!")
                tree.suspicion += 10.0
            tree.add_process(pid=pid, ppid=ppid, image=source_image)


    def handle_terminateproc(self, fields, tree):
        pid = int(fields[1])
        return

    def handle_openprocess(self, fields, tree):
        action = fields[0]
        target = int(fields[1])
        actor = int(fields[2])
        
        if actor not in tree.get_processes():
            return

        if target == actor:
            return

        if ((action == 'Proces-memory-write-accessattempt') or
            (action == 'Proces-operation-memory-write-accessattempt')
        ):
            if target not in tree.processes[actor].children:
                is_there = False
                for i in tree.events:
                    if ((i.get_type() == TYPE_WRITE_OTHER) and
                        (i.args['target_pid'] == target)
                    ):
                        is_there = True
                        break

                if is_there == False:
                    logger.debug(f"Process {actor} requesting non-child process {target} write access")
                    event = Event(TYPE_WRITE_OTHER)
                    event.add_arg('target_pid', target)
                    tree.add_event(event)

                    # Search previous events for similar occurence of VM Write request
                    if tree.search_event(event, 20) > 0.4:
                        logger.debug(f"Excessive VM write request detected.")
                        # Scoring
                        tree.suspicion += 1.0

        elif (action == 'Proces-terminate-attempt'):
            if target not in tree.processes[actor].children:
                is_there = False
                for i in tree.events:
                    if ((i.get_type() == TYPE_TERM_OTHER) and
                        (i.args['target_pid'] == target)
                    ):
                        is_there = True
                        break

                if is_there == False:
                    logger.debug(f"Process {actor} requesting non-child process {target} terminate access")
                    event = Event(TYPE_TERM_OTHER)
                    event.add_arg('target_pid', target)
                    tree.add_event(event)

                    # Search previous events for similar occurence of termination request
                    if tree.search_event(event, 20) > 0.4:
                        logger.debug(f"Excessive termination request detected.")
                        # Add scoring mechanism here
                        tree.suspicion += 3.0

        elif (action == 'Proces-suspent-resume-accessattempt'):
            if target not in tree.processes[actor].children:
                is_there = False
                for i in tree.events:
                    if ((i.get_type() == TYPE_THREAD_OTHER) and
                        (i.args['target_pid'] == target)
                    ):
                        is_there = True
                        break

                if is_there == False:
                    logger.debug(f"Process {actor} requesting non-child process {target} thread access")
                    event = Event(TYPE_THREAD_OTHER)
                    event.add_arg('target_pid', target)
                    tree.add_event(event)

                    # Search previous events for similar occurence of termination request
                    if tree.search_event(event, 20) > 0.4:
                        logger.debug(f"Excessive thread request detected.")
                        # Add scoring mechanism here
                        tree.suspicion += 2.0

        elif (action == 'Proce-smemory-write-delete-access-attempt'):
            if target not in tree.processes[actor].children:
                logger.debug(f"Process {actor} requesting non-child process {target} all access")
                tree.suspicion += 10.0

        else:
            return
